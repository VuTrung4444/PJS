--// Variables \\--
local plr = game:GetService("Players").LocalPlayer

local function updateCharacterReferences(character)
	local hrp = character:WaitForChild("HumanoidRootPart")
		_G.Character = character
		_G.HumanoidRootPart = hrp
end
	if plr.Character then
		updateCharacterReferences(plr.Character)
	end
	plr.CharacterAdded:Connect(function(character)
    updateCharacterReferences(character)
end)

local insert = table.insert 
local character = plr.Character
local PlrHumanoidRootPart = character:WaitForChild("HumanoidRootPart")

local plr = game.Players.LocalPlayer
local Character = plr.Character or plr.CharacterAdded:Wait()	
local Humanoid = Character and Character:WaitForChild("Humanoid")
local WalkSpeed = 150
local JumpPower = 150

plr.CharacterAdded:Connect(function(Char)
    Character = Char
    Humanoid = Character:WaitForChild("Humanoid")

    -- C·∫≠p nh·∫≠t t·ªëc ƒë·ªô v√† s·ª©c b·∫≠t ngay khi nh√¢n v·∫≠t xu·∫•t hi·ªán
    if WalkSpeed then
        Humanoid.WalkSpeed = WalkSpeed
    end
    if JumpPower then
        Humanoid.JumpPower = JumpPower
    end
end)

game:GetService("RunService").Stepped:Connect(function()
    if Character and Humanoid then
        -- Gi·ªØ t·ªëc ƒë·ªô ch·∫°y c·ªë ƒë·ªãnh
        if Humanoid.WalkSpeed ~= WalkSpeed then
            Humanoid.WalkSpeed = WalkSpeed
        end
        
        -- Gi·ªØ s·ª©c b·∫≠t c·ªë ƒë·ªãnh
        if Humanoid.JumpPower ~= JumpPower then
            Humanoid.JumpPower = JumpPower
        end
    end
end)

plr.CharacterAdded:Connect(function(Char)
    Character = Char
    Humanoid = Character:WaitForChild("Humanoid")

    -- ƒê·∫∑t l·∫°i t·ªëc ƒë·ªô ngay l·∫≠p t·ª©c
    task.wait(0.1) -- Ch·ªù game c·∫≠p nh·∫≠t xong
    Humanoid.WalkSpeed = WalkSpeed
    Humanoid.JumpPower = JumpPower
end)

--// Tween \\--
local function GetDistance(Endpoint)
    if typeof(Endpoint) == "Instance" then
        Endpoint = Vector3.new(Endpoint.Position.X, game.Players.LocalPlayer.Character.HumanoidRootPart.Position.Y, Endpoint.Position.Z)
    elseif typeof(Endpoint) == "CFrame" then
        Endpoint = Vector3.new(Endpoint.Position.X, game.Players.LocalPlayer.Character.HumanoidRootPart.Position.Y, Endpoint.Position.Z)
    end
    local Magnitude = (Endpoint - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
    return Magnitude
end

function Tween(Endpoint)
  if typeof(Endpoint) == "Instance" then
        Endpoint = Endpoint.CFrame
    end
    local TweenFunc = {}
    local Distance = GetDistance(Endpoint)
    local TweenInfo = TweenInfo.new(Distance / getgenv().tweenspeed, Enum.EasingStyle.Linear)

    local targetCFrame = Endpoint

    -- Gi·ªØ nguy√™n h∆∞·ªõng nh√¨n khi ·ªü ch·∫ø ƒë·ªô "Above" ho·∫∑c "Below"
    if FarmMethod == "Above" then
        targetCFrame = CFrame.new(Endpoint.Position) * CFrame.Angles(math.rad(-90), 0, 0)
    elseif FarmMethod == "Below" then
        targetCFrame = CFrame.new(Endpoint.Position) * CFrame.Angles(math.rad(90), 0, 0)
    end

    local TweenObj = game:GetService("TweenService"):Create(
        game.Players.LocalPlayer.Character.HumanoidRootPart, 
        TweenInfo, 
        { CFrame = targetCFrame }
    )
    TweenObj:Play()

    function TweenFunc:Cancel()
        TweenObj:Cancel()
        return false
    end

    if Distance <= 100 then
        game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = targetCFrame
        TweenObj:Cancel()
        return false
    end

    return TweenFunc
end

local function EnableAntiFall()
    local plr = game.Players.LocalPlayer
    if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
        return
    end

    local humanoidRootPart = plr.Character.HumanoidRootPart
    if not humanoidRootPart:FindFirstChild("BodyVelocity") then
        local antifall = Instance.new("BodyVelocity")
        antifall.Velocity = Vector3.new(0, 0, 0)
        antifall.MaxForce = Vector3.new(9e9, 9e9, 9e9)
        antifall.Name = "BodyVelocity"
        antifall.Parent = humanoidRootPart
    end
end

local function DisableAntiFall()
    local plr = game.Players.LocalPlayer
    if not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then
        return
    end

    local humanoidRootPart = plr.Character.HumanoidRootPart
    local humanoid = plr.Character:FindFirstChildOfClass("Humanoid")
    local antifall = humanoidRootPart:FindFirstChild("BodyVelocity")

    -- X√≥a l·ª±c AntiFall n·∫øu t·ªìn t·∫°i
    if antifall then
        antifall:Destroy()
        task.wait(0.1) -- Ch·ªù m·ªôt ch√∫t ƒë·ªÉ ch·∫Øc ch·∫Øn r·∫±ng BodyVelocity ƒë√£ b·ªã x√≥a
    end

    -- ƒê·∫∑t l·∫°i v·∫≠n t·ªëc ƒë·ªÉ tr√°nh b·ªã gi·ªØ l·∫°i b·ªüi l·ª±c c≈©
    humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)

    -- ƒê·∫£m b·∫£o nh√¢n v·∫≠t c√≥ th·ªÉ di chuy·ªÉn
    if humanoid then
        humanoid.PlatformStand = false  -- NgƒÉn tr·∫°ng th√°i ƒë·ª©ng y√™n c·ª©ng
        humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)  -- ƒê∆∞a nh√¢n v·∫≠t v·ªÅ tr·∫°ng th√°i b√¨nh th∆∞·ªùng
        task.wait(0.1)  -- Ch·ªù m·ªôt ch√∫t ƒë·ªÉ tr·∫°ng th√°i ƒë∆∞·ª£c c·∫≠p nh·∫≠t

        -- Nh·∫£y ngay l·∫≠p t·ª©c ƒë·ªÉ ki·ªÉm tra xem c√≥ b·ªã kh√≥a kh√¥ng
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end


--// Get Closest \\---
function IsEntitySelected(entity, selectedEntities)
    for _, selectedEntity in ipairs(selectedEntities) do
        if entity.Name == selectedEntity then
            return true
        end
    end
    return false
end



function getclosest(selectedEntities, parentFolder)
    local closestEntity = nil
    local closestDistance = math.huge

    local entities = parentFolder:GetDescendants()

    for i, entity in ipairs(entities) do
        if entity:IsA("Model") and IsEntitySelected(entity, selectedEntities) then
            local entityName = entity.Name
            local humanoid = entity:FindFirstChild("Humanoid")
            if humanoid and humanoid.Health > 0 then
                local entityCFrame = entity:GetModelCFrame()
                local distance = (entityCFrame.Position - game.Players.LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestEntity = entity
                end
            end
        end
    end

    return closestEntity
end

--// Main Script \\--
local library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Subs = library.subs
local IsOpen = Subs.Wait

local Window = library:CreateWindow({
    Name = "HackerLor | GhoulNoob",
    Themeable = {
        Info = "VTrungHackerLor",
        Credit = false,
        Background = "",
        Visible = true
    }
})

--// Main Tab \\--
local MainTab = Window:CreateTab({Name = "Main"})
local MainSection = MainTab:CreateSection({Name = "Farming"})
local Settings = MainTab:CreateSection({Name = "Settings"})
local KillAura = MainTab:CreateSection({Name = "Kill Aura", Side = "Right"})


--// Misc Tab \\--
local MiscTab = Window:CreateTab({Name = "Misc"})
local MiscSection = MiscTab:CreateSection({Name = "Misc"})
local SpeedAndJump = MiscTab:CreateSection({Name = "Speed&Jump", Side = "Right"})
local Ect = MiscTab:CreateSection({Name = "Ect", Side = "Left"})

--ServerHop--
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local placeId = game.PlaceId
local localPlayer = Players.LocalPlayer
local visitedServers = {}
local hopCooldown = 5

local isTeleporting = false

local currentJobId = game.JobId 

local function hopToLowPopServer()
    if isTeleporting then return end

    local success, servers = pcall(function()
        return HttpService:JSONDecode(
            game:HttpGet("https://games.roblox.com/v1/games/" .. placeId .. "/servers/Public?sortOrder=Asc&limit=100")
        )
    end)

    if success and servers and servers.data then
        for _, server in ipairs(servers.data) do
            local serverId = server.id
            local playerCount = server.playing

            if serverId ~= currentJobId and playerCount >= 1 and playerCount <= 2 and not visitedServers[serverId] then
                visitedServers[serverId] = true
                isTeleporting = true
                TeleportService:TeleportToPlaceInstance(placeId, serverId, localPlayer)
                break
            end
        end
    end
end



-- G·∫Øn v√†o toggle
local hopEnabled = false
MiscSection:AddToggle({
    Name = "Server Hop",
    Flag = "AutoHop",
    Callback = function(v)
        hopEnabled = v
        if hopEnabled then
            task.spawn(function()
                while hopEnabled do
                    hopToLowPopServer()
                    task.wait(hopCooldown)
                end
            end)
        end
    end
})


--// Settings \\--
Settings:AddDropdown({
    Name = "Farm Method",
    List = {"Above","Behind","Below"},
    Flag = "FarmMethodSelection",
    Nothing = "Select Method...",
	Value = "Above",
    Callback = function(Chosen)
        FarmMethod = Chosen 
    end
})

Settings:AddSlider({
    Name = "Distance",
    Flag = "DistanceSlider",
    Value = 10,
    Min = 1,
    Max = 200,
    Textbox = true,
    Callback = function(Value)
        getgenv().Distance = Value
    end
})

Settings:AddSlider({
    Name = "Tween Speed",
    Flag = "TweenSlider",
    Value = 300,
    Min = 150,
    Max = 500,
    Textbox = true,
    Callback = function(Value)
        getgenv().tweenspeed = Value
    end
})

SpeedAndJump:AddSlider({
    Name = "WalkSpeed",
    Value = 150,
    Min = 16,
    Max = 300,
    Flag = "WalkSpeed",
	Textbox = true,
    Callback = function(State)
        WalkSpeed = State
        if game.Players.LocalPlayer.Character then
            local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.WalkSpeed = WalkSpeed
            end
        end
    end
})

SpeedAndJump:AddSlider({
    Name = "JumpPower",
    Value = 50,
    Min = 50,
    Max = 1000,
    Flag = "JumpPower",
	Textbox = true,
    Callback = function(State)
        JumpPower = State
        if game.Players.LocalPlayer.Character then
            local humanoid = game.Players.LocalPlayer.Character:FindFirstChild("Humanoid")
            if humanoid then
                humanoid.JumpPower = JumpPower
            end
        end
    end
})

local autoQuest = false
local fixedPosition = Vector3.new(7693.7041, 26.34376, -692.12549)

MainSection:AddToggle({
    Name = "Auto Accept Quest (ClickDetector)",
    Flag = "AutoQuestClickFixed",
    Callback = function(v)
        autoQuest = v
        if autoQuest then
            task.spawn(function()

                local function getBoardPosition(obj)
                    if obj:IsA("Model") then
                        return obj:GetPivot().Position
                    elseif obj:IsA("BasePart") then
                        return obj.Position
                    end
                    return nil
                end

                while autoQuest do
                    local board = nil
                    local a = workspace.MissionBoards.CCG.MissionBoard
                    local b = workspace.MissionBoards.CCG:GetChildren()[2]

                    local posA = getBoardPosition(a)
                    local posB = getBoardPosition(b)

                    if a and posA and (posA - fixedPosition).Magnitude < 1 then
                        board = a
                    elseif b and posB and (posB - fixedPosition).Magnitude < 1 then
                        board = b
                    end

                    if not board then
                        print("[DEBUG] ‚ùå Kh√¥ng t√¨m th·∫•y mission board t·∫°i v·ªã tr√≠ chu·∫©n")
                        task.wait(1)
                        continue
                    end

                    local holder = board:FindFirstChild("Holder")
                    if not holder then
                        print("[DEBUG] ‚ùå Holder not found")
                        task.wait(1)
                        continue
                    end

                    local foundHard = false
                    for i = 1, 10 do
                        local part = holder:FindFirstChild(tostring(i))
                        if not part then
                            print("[DEBUG] üîç Holder[" .. i .. "] not found")
                            continue
                        end

                        local gui = part:FindFirstChild("SurfaceGui")
                        local rating = gui and gui:FindFirstChild("Rating")
                        if not rating or not rating:IsA("TextLabel") then
                            print("[DEBUG] ‚ùå Rating missing or invalid at number " .. i)
                            continue
                        end

                        print("[DEBUG] ‚úÖ Rating at [" .. i .. "]:", rating.Text)

                        if rating.Text == "Hard" then
                            local detector = part:FindFirstChild("ClickDetector")
                            if detector then
                                print("[DEBUG] üñ±Ô∏è Clicking Holder[" .. i .. "]")
                                fireclickdetector(detector)
                                foundHard = true
                                break
                            else
                                print("[DEBUG] ‚ùå No ClickDetector at number " .. i)
                            end
                        end
                    end

                    if not foundHard then
                        print("[DEBUG] üò¢ No 'Hard' mission found this round")
                    end

                    task.wait(10)
                end
            end)
        end
    end
})

local autoAttack = false
local VirtualInputManager = game:GetService("VirtualInputManager")

-- H√†m th·ª±c hi·ªán c·∫£ vi·ªác click chu·ªôt v√† nh·∫•n ph√≠m R
local function performAction()
    for i = 1, 4 do
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 0)
        task.wait(0.2)  -- Th·ªùi gian gi·ªØ chu·ªôt
        VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 0)
        task.wait(0.5)  -- Ch·ªù gi·ªØa c√°c l·∫ßn nh·∫•n chu·ªôt
    end
	task.wait(0.5)
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.R, false, game)
    task.wait(1.5)  -- Ch·ªù sau khi nh·∫•n ph√≠m R ƒë·ªÉ tr√°nh spam qu√° nhanh
end

-- Toggle b·∫≠t/t·∫Øt AutoAttack
MainSection:AddToggle({
    Name = "AutoAttack",
    Flag = "AutoAttack",
    Callback = function(state)
        autoAttack = state
        if autoAttack then
            -- Khi toggle b·∫≠t, ch·ªâ sau ƒë√≥ m·ªõi b·∫Øt ƒë·∫ßu v√≤ng l·∫∑p
            task.spawn(function()
                while autoAttack do
                    performAction()  -- Th·ª±c hi·ªán c·∫£ click chu·ªôt v√† nh·∫•n R
                    task.wait(1.5)  -- Th·ªùi gian ch·ªù gi·ªØa c√°c v√≤ng l·∫∑p
                end
            end)
        end
    end
})

local tweenToTatara = false
local floatAttachment

MainSection:AddToggle({
    Name = "Tween To Tatara Boss",
    Default = false,
    Callback = function(value)
        tweenToTatara = value

        local TweenService = game:GetService("TweenService")
        local Players = game:GetService("Players")
        local VirtualInputManager = game:GetService("VirtualInputManager")

        local LocalPlayer = Players.LocalPlayer
        local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local HRP = Character:WaitForChild("HumanoidRootPart")
        local Humanoid = Character:WaitForChild("Humanoid")

        -- N·∫øu t·∫Øt toggle
        if not tweenToTatara then
            Humanoid.PlatformStand = false
            if floatAttachment then
                floatAttachment:Destroy()
                floatAttachment = nil
            end
            print("üõë ƒê√£ h·ªßy tr·∫°ng th√°i bay.")
            return
        end

        -- B·∫≠t PlatformStand
        Humanoid.PlatformStand = true
        print("üïäÔ∏è B·∫≠t PlatformStand (bay).")

        -- Ki·ªÉm tra blade v√† ·∫©n blade n·∫øu c·∫ßn
        local entityName = LocalPlayer.Name
        local playerEntity = workspace.Entities:FindFirstChild(entityName)
        if playerEntity and playerEntity:FindFirstChild("Weapon") and playerEntity.Weapon:FindFirstChild("Blade") then
            if playerEntity.Weapon.Blade.Transparency == 1 then
                VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.E, false, game)
                task.wait(0.2)
                VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.E, false, game)
                print("üéØ Blade ·∫©n, ƒë√£ ·∫•n ph√≠m E ƒë·ªÉ b·∫≠t.")
            end
        end

        -- T√¨m boss Tatara
        local bossModel
        for _, entity in ipairs(workspace.Entities:GetChildren()) do
            if string.match(entity.Name, "^Tatara_") then
                bossModel = entity
                break
            end
        end

        if not bossModel then
            warn("‚ùå Kh√¥ng t√¨m th·∫•y boss c√≥ t√™n b·∫Øt ƒë·∫ßu b·∫±ng 'Tatara_'.")
            return
        end

        local bossRig = bossModel:FindFirstChild("TataraBossRig")
        if not bossRig then
            warn("‚ùå Kh√¥ng t√¨m th·∫•y TataraBossRig trong bossModel.")
            return
        end

        local targetPart = bossRig.PrimaryPart or bossRig:FindFirstChild("HumanoidRootPart") or bossRig:FindFirstChildWhichIsA("BasePart")
        if not targetPart then
            warn("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn ch√≠nh ƒë·ªÉ tween t·ªõi boss.")
            return
        end

        -- V√≤ng l·∫∑p ki·ªÉm tra ƒëi·ªÅu ki·ªán v√† di chuy·ªÉn li√™n t·ª•c
        while tweenToTatara do
            -- Ki·ªÉm tra ƒëi·ªÅu ki·ªán
            local distance = (HRP.Position - targetPart.Position).Magnitude
            local healthPercent = Humanoid.Health / Humanoid.MaxHealth * 100
            print("üìä Health:", healthPercent, "Distance:", distance)

            local tweenInfo = TweenInfo.new(0.5, Enum.EasingStyle.Linear)
            local goalCFrame

            -- ƒêi·ªÅu ki·ªán di chuy·ªÉn ƒë·∫øn boss ho·∫∑c bay xu·ªëng s√¢u
            if healthPercent >= 90 and distance > 50 then
                goalCFrame = targetPart.CFrame + Vector3.new(0, -15, 2)
                print("‚úàÔ∏è Bay ƒë·∫øn boss (m√°u kh·ªèe v√† ƒë·ªß xa).")
            elseif healthPercent <= 75 then
                goalCFrame = CFrame.new(HRP.Position.X, -1000, HRP.Position.Z)
                print("üîª Bay xu·ªëng s√¢u v√¨ m√°u <= 75%.")
            else
                goalCFrame = HRP.CFrame  -- Gi·ªØ nguy√™n v·ªã tr√≠ n·∫øu kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán
                print("‚ö†Ô∏è Kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ tween, nh∆∞ng v·∫´n duy tr√¨ tr·∫°ng th√°i bay.")
            end

            -- Tween tr∆∞·ªõc, r·ªìi m·ªõi kh√≥a t·∫°i ch·ªó
            local tween = TweenService:Create(HRP, tweenInfo, {CFrame = goalCFrame})
            tween:Play()
            tween.Completed:Wait()

            print("‚úÖ Tween ho√†n t·∫•t.")

            -- ƒê√≥ng bƒÉng sau khi tween
            if floatAttachment then
                floatAttachment:Destroy()
            end

            -- T·∫°o tr·∫°ng th√°i bay b·∫±ng BodyGyro & BodyVelocity
            floatAttachment = Instance.new("BodyGyro")
            floatAttachment.MaxTorque = Vector3.new(400000, 400000, 400000)  -- C√¢n b·∫±ng v·ªõi c√°c l·ª±c xoay
            floatAttachment.CFrame = HRP.CFrame
            floatAttachment.Parent = HRP

            local bodyVelocity = Instance.new("BodyVelocity")
            bodyVelocity.MaxForce = Vector3.new(400000, 400000, 400000)
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)  -- Gi·ªØ nguy√™n v·ªã tr√≠ tr√™n kh√¥ng
            bodyVelocity.Parent = HRP

            print("üìç Nh√¢n v·∫≠t ƒë√£ ƒë∆∞·ª£c gi·ªØ c·ªë ƒë·ªãnh trong tr·∫°ng th√°i bay.")

            -- C·∫≠p nh·∫≠t v·ªã tr√≠ c·ªßa nh√¢n v·∫≠t theo boss sau m·ªói l·∫ßn ki·ªÉm tra ƒëi·ªÅu ki·ªán
            task.wait(0.5)  -- C·∫≠p nh·∫≠t m·ªói n·ª≠a gi√¢y ho·∫∑c c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh theo nhu c·∫ßu
        end
    end
})
