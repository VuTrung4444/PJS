repeat task.wait() until game:IsLoaded()

local Library = loadstring(game:GetObjects("rbxassetid://7657867786")[1].Source)()
local Subs = Library.subs
local IsOpen = Subs.Wait

local mainMenuPlaceID = 10450270085
local BossPlaceID = 16379688837
local InvestPlaceID = 16379684339
local placeId = game.PlaceId


local InnateSpinEnabled = false
local slot1Enabled = false
local slot2Enabled = false
local huntLegendary = false  
local huntSg = false


local legendaryInnate = {"Volcano", "Hydrokinesis", "Judgeman", "Puppet", "Projection", "Plan Manipulation"}
local sgInnate = {"Infinity", "Demon Vessel", "Curse Queen", "Soul Manipulation", "Gamble Fever", "Star Rage", "Ancient Construction", "Thunder God"}


local function getFilteredInnate()
    local targetInnate = {}
    if huntLegendary then
        for _, innate in ipairs(legendaryInnate) do
            table.insert(targetInnate, innate)
        end
    end
    if huntSg then
        for _, innate in ipairs(sgInnate) do
            table.insert(targetInnate, innate)
        end
    end
    return targetInnate
end


local function autoSpinInnate()
    task.spawn(function()
        local Players = game:GetService("Players")
        local ReplicatedStorage = game:GetService("ReplicatedStorage")
        local localPlayer = Players.LocalPlayer


        local spinRemote = ReplicatedStorage:WaitForChild("Remotes")
            :WaitForChild("Server")
            :WaitForChild("Data")
            :WaitForChild("InnateSpin")


        local innates = localPlayer:WaitForChild("ReplicatedData"):WaitForChild("innates")

        while InnateSpinEnabled do
            local targetInnates = getFilteredInnate()


            if slot1Enabled then
                spinRemote:InvokeServer(1)
                local val1 = innates["1"] and innates["1"].Value or ""
                print("Slot 1 Innate:", val1)
                if table.find(targetInnates, val1) then
                    InnateSpinEnabled = false
                    break
                end
            end


            if slot2Enabled then
                if slot1Enabled then task.wait(0.5) end -- Slot 2 quay chậm hơn nếu slot 1 cũng spin
                spinRemote:InvokeServer(2)
                local val2 = innates["2"] and innates["2"].Value or ""
                print("Slot 2 Innate:", val2)
                if table.find(targetInnates, val2) then
                    InnateSpinEnabled = false
                    break
                end
            end

            task.wait(0.3)
        end
    end)
end


    local Window = Library:CreateWindow({
        Name = "HackerLor",
        Themeable = {
            Info = "VTrungHackerLor",
            Credit = false,
            Background = "",
            Visible = true
        }
    })

	--// Main Tab \\--
	local MainTab = Window:CreateTab({Name = "Main"})
	local MainSection = MainTab:CreateSection({Name = "Farming"})
	local Settings = MainTab:CreateSection({Name = "Settings"})
	local KA = MainTab:CreateSection({Name = "Kill Aura", Side = "Left"})
	local AutoMission = MainTab:CreateSection({Name = "Auto", Side = "Right"})
	local DailySection = MainTab:CreateSection({Name = "Spin", Side = "Left"})
	local Teleports = MainTab:CreateSection({Name = "Teleports", Side = "Right"})
	local AuraTab = MainTab:CreateSection({Name = "AuraSkills", Side = "Left"})


	--// Misc Tab \\--
	local MiscTab = Window:CreateTab({Name = "Misc"})
	local MiscSection = MiscTab:CreateSection({Name = "Misc"})
	local Ect = MiscTab:CreateSection({Name = "Ect", Side = "Left"})
	local Breathings = MiscTab:CreateSection({Name = "Breathings", Side = "Left"})
	local SpeedAndJump = MiscTab:CreateSection({Name = "Speed&Jump", Side = "Right"})



    -- Toggle Auto Spin
    DailySection:AddToggle({
        Name = "Auto Spin Innate",
        Flag = "AutoSpinInnate",
        Callback = function(state)
            InnateSpinEnabled = state
            if state then autoSpinInnate() end
        end
    })

    -- Toggle slot 1
    DailySection:AddToggle({
        Name = "Spin Thanh Lưu 1",
        Flag = "Slot1",
        State = false,
        Callback = function(state)
            slot1Enabled = state
        end
    })

    -- Toggle slot 2
    DailySection:AddToggle({
        Name = "Spin Thanh Lưu 2",
        Flag = "Slot2",
        State = false,
        Callback = function(state)
            slot2Enabled = state
        end
    })

    -- Hunt Legendary / SG Innate
    local ClanChooseSection = MainTab:CreateSection({Name = "TròChơiNhânPhẩm", Side = "Right"})

    ClanChooseSection:AddToggle({
        Name = "Săn Legendary Innate",
        Flag = "HuntLegendary",
        Callback = function(state)
            huntLegendary = state
        end
    })

    ClanChooseSection:AddToggle({
        Name = "Săn Sg Innate",
        Flag = "HuntSg",
        Callback = function(state)
            huntSg = state
        end
    })

local ToggleBF = false
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer

local function GetNearestMobInRange(range)
    local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
    local char = player.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        local hum = mob:FindFirstChild("Humanoid")
        local root = mob.PrimaryPart or mob:FindFirstChild("HumanoidRootPart")

        if hum and hum.Health >= 0 and root then
            if (hrp.Position - root.Position).Magnitude <= range then
                return mob
            end
        end
    end

    return nil
end

KA:AddToggle({
    Name = "BlackFlash Loop",
    Default = false,
    Callback = function(v)
        ToggleBF = v
        
        if v then
            task.spawn(function()
                while ToggleBF do
                    local mob = GetNearestMobInRange(100)

                    if mob then
                        -- chạy blackflash
                        local args = {1.123}
                        local rs = game:GetService("ReplicatedStorage").Remotes.Server.Combat

                        rs.ApplyBlackFlashToNextHitbox:FireServer(unpack(args))
                        rs.M2:FireServer()
                    end

                    task.wait(0.3)
                end
            end)
        end
    end
})

	--// Kill Aura Toggle \\--
	KA:AddToggle({
		Name = "Kill Aura",
		Flag = "KillAuraToggle",
		Callback = function(v)
			getgenv().KillAura = v
		end
	})


Ect:AddToggle({
    Name = "HopServer",
    Flag = "HopServerToggle",
    Callback = function(state)
        getgenv().HopServerEnabled = state
        if state then
            task.spawn(function()
                while getgenv().HopServerEnabled do
                    -- Hàm hop server
                    local HttpService = game:GetService("HttpService")
                    local TeleportService = game:GetService("TeleportService")
                    local Players = game:GetService("Players")
                    local placeId = game.PlaceId

                    local function getLowPopServer()
                        local url = string.format("https://games.roblox.com/v1/games/%d/servers/Public?sortOrder=Asc&limit=100", placeId)
                        local success, response = pcall(function()
                            return game:HttpGet(url)
                        end)
                        if success and response then
                            local data = HttpService:JSONDecode(response)
                            for _, server in ipairs(data.data) do
                                if server.playing == 1 and server.maxPlayers > 1 then
                                    return server.id
                                end
                            end
                        end
                    end

                    local function hopToLowPopServer()
                        local serverId = getLowPopServer()
                        if serverId then
                            TeleportService:TeleportToPlaceInstance(placeId, serverId, Players.LocalPlayer)
                        end
                    end

                    hopToLowPopServer()

                    task.wait(10)
                end
            end)
        end
    end
})

--// Services \\--
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

--// Biến điều khiển ESP \\--
getgenv().ESPenabled = false
local ESPDistance = true
local ESPTextSize = 18

--// Hàm tạo ESP cho một người chơi \\--
local function createESP(player)
    if player == LocalPlayer then return end
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end

    -- Nếu đã có ESP, xóa trước
    if player.Character:FindFirstChild("ESP") then
        player.Character:FindFirstChild("ESP"):Destroy()
    end

    -- Tạo BillboardGui
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP"
    billboard.Adornee = player.Character:WaitForChild("HumanoidRootPart")
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = player.Character

    -- TextLabel hiển thị tên + khoảng cách
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
    textLabel.TextStrokeTransparency = 0
    textLabel.Font = Enum.Font.SourceSansBold
    textLabel.TextScaled = false
    textLabel.TextSize = ESPTextSize
    textLabel.Parent = billboard

    -- Cập nhật thông tin liên tục
    task.spawn(function()
        while getgenv().ESPenabled and player.Character and player.Character:FindFirstChild("HumanoidRootPart") do
            local distance = (player.Character.HumanoidRootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            if ESPDistance then
                textLabel.Text = player.Name .. " | " .. math.floor(distance) .. " studs"
            else
                textLabel.Text = player.Name
            end
            task.wait(2)
        end
        if billboard then billboard:Destroy() end
    end)
end

--// Tạo ESP cho tất cả người chơi hiện tại \\--
local function updateAllPlayersESP()
    for _, player in pairs(Players:GetPlayers()) do
        createESP(player)
    end
end

--// Kết nối PlayerAdded một lần duy nhất \\--
Players.PlayerAdded:Connect(function(player)
    -- Nếu ESP đang bật thì tạo ESP cho người chơi mới ngay
    if getgenv().ESPenabled then
        player.CharacterAdded:Wait() -- chờ character xuất hiện
        createESP(player)
    end
end)

--// Toggle ESP \\--
Ect:AddToggle({
    Name = "ESP",
    Flag = "ESP_Toggle",
    Callback = function(state)
        getgenv().ESPenabled = state
        if state then
            updateAllPlayersESP()
        else
            -- Xóa tất cả ESP khi tắt
            for _, player in pairs(Players:GetPlayers()) do
                if player.Character and player.Character:FindFirstChild("ESP") then
                    player.Character.ESP:Destroy()
                end
            end
        end
    end
})


local Noclip = nil
local Clip = nil

function noclip()
    Clip = false
    local function Nocl()
        if Clip == false and game.Players.LocalPlayer.Character ~= nil then
            for _,v in pairs(game.Players.LocalPlayer.Character:GetDescendants()) do
                if v:IsA('BasePart') and v.CanCollide and v.Name ~= floatName then
                    v.CanCollide = false
                end
            end
        end
        wait(0.21) 
    end
    Noclip = game:GetService('RunService').Stepped:Connect(Nocl)
end

function clip()
    if Noclip then Noclip:Disconnect() end
    Clip = true
end

Ect:AddToggle({
    Name = "Noclip",
    Default = false,
    Callback = function(value)
        if value then
            noclip()
        else
            clip()
        end
    end
})

	--// NoClip \\--
	local antifallActive = false 
	spawn(function()
		game:GetService("RunService").Stepped:Connect(function()
			if getgenv().Farm or getgenv().MoveAround or getgenv().AutoCollect or getgenv().AutoMoveEnabled then
				for _, v in pairs(game:GetService("Players").LocalPlayer.Character:GetDescendants()) do
					if v:IsA("BasePart") then
						v.CanCollide = false    
					end
					if v:IsA("Humanoid") then
						v:ChangeState(11)
					end
				end
				if not antifallActive then  -- Check if no clip is already active
					antifallActive = true
					EnableAntiFall()
				end
			else
				if antifallActive then
					antifallActive = false
					DisableAntiFall()
				end
			end
		end)
	end)

Ect:AddButton({
    Name = "Fly",
    Default = false,
    Callback = function(state)
        getgenv().Fly = state
        if state then
			local main = Instance.new("ScreenGui")
			local Frame = Instance.new("Frame")
			local up = Instance.new("TextButton")
			local down = Instance.new("TextButton")
			local onof = Instance.new("TextButton")
			local TextLabel = Instance.new("TextLabel")
			local plus = Instance.new("TextButton")
			local speed = Instance.new("TextLabel")
			local mine = Instance.new("TextButton")
			local closebutton = Instance.new("TextButton")
			local mini = Instance.new("TextButton")
			local mini2 = Instance.new("TextButton")

			main.Name = "main"
			main.Parent = game.Players.LocalPlayer:WaitForChild("PlayerGui")
			main.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
			main.ResetOnSpawn = false

			Frame.Parent = main
			Frame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
			Frame.BorderColor3 = Color3.fromRGB(103, 221, 213)
			Frame.Position = UDim2.new(0.100320168, 0, 0.379746825, 0)
			Frame.Size = UDim2.new(0, 190, 0, 57)

			up.Name = "up"
			up.Parent = Frame
			up.BackgroundColor3 = Color3.fromRGB(79, 255, 152)
			up.Size = UDim2.new(0, 44, 0, 28)
			up.Font = Enum.Font.SourceSans
			up.Text = "UP"
			up.TextColor3 = Color3.fromRGB(0, 0, 0)
			up.TextSize = 14.000

			down.Name = "down"
			down.Parent = Frame
			down.BackgroundColor3 = Color3.fromRGB(215, 255, 121)
			down.Position = UDim2.new(0, 0, 0.491228074, 0)
			down.Size = UDim2.new(0, 44, 0, 28)
			down.Font = Enum.Font.SourceSans
			down.Text = "DOWN"
			down.TextColor3 = Color3.fromRGB(0, 0, 0)
			down.TextSize = 14.000

			onof.Name = "onof"
			onof.Parent = Frame
			onof.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
			onof.Position = UDim2.new(0.702823281, 0, 0.491228074, 0)
			onof.Size = UDim2.new(0, 56, 0, 28)
			onof.Font = Enum.Font.SourceSans
			onof.Text = "fly"
			onof.TextColor3 = Color3.fromRGB(0, 0, 0)
			onof.TextSize = 14.000

			TextLabel.Parent = Frame
			TextLabel.BackgroundColor3 = Color3.fromRGB(242, 60, 255)
			TextLabel.Position = UDim2.new(0.469327301, 0, 0, 0)
			TextLabel.Size = UDim2.new(0, 100, 0, 28)
			TextLabel.Font = Enum.Font.SourceSans
			TextLabel.Text = "FLY GUI V3"
			TextLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
			TextLabel.TextScaled = true
			TextLabel.TextSize = 14.000
			TextLabel.TextWrapped = true

			plus.Name = "plus"
			plus.Parent = Frame
			plus.BackgroundColor3 = Color3.fromRGB(133, 145, 255)
			plus.Position = UDim2.new(0.231578946, 0, 0, 0)
			plus.Size = UDim2.new(0, 45, 0, 28)
			plus.Font = Enum.Font.SourceSans
			plus.Text = "+"
			plus.TextColor3 = Color3.fromRGB(0, 0, 0)
			plus.TextScaled = true
			plus.TextSize = 14.000
			plus.TextWrapped = true

			speed.Name = "speed"
			speed.Parent = Frame
			speed.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
			speed.Position = UDim2.new(0.468421042, 0, 0.491228074, 0)
			speed.Size = UDim2.new(0, 44, 0, 28)
			speed.Font = Enum.Font.SourceSans
			speed.Text = "1"
			speed.TextColor3 = Color3.fromRGB(0, 0, 0)
			speed.TextScaled = true
			speed.TextSize = 14.000
			speed.TextWrapped = true

			mine.Name = "mine"
			mine.Parent = Frame
			mine.BackgroundColor3 = Color3.fromRGB(123, 255, 247)
			mine.Position = UDim2.new(0.231578946, 0, 0.491228074, 0)
			mine.Size = UDim2.new(0, 45, 0, 29)
			mine.Font = Enum.Font.SourceSans
			mine.Text = "-"
			mine.TextColor3 = Color3.fromRGB(0, 0, 0)
			mine.TextScaled = true
			mine.TextSize = 14.000
			mine.TextWrapped = true

			closebutton.Name = "Close"
			closebutton.Parent = main.Frame
			closebutton.BackgroundColor3 = Color3.fromRGB(225, 25, 0)
			closebutton.Font = "SourceSans"
			closebutton.Size = UDim2.new(0, 45, 0, 28)
			closebutton.Text = "X"
			closebutton.TextSize = 30
			closebutton.Position =  UDim2.new(0, 0, -1, 27)

			mini.Name = "minimize"
			mini.Parent = main.Frame
			mini.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
			mini.Font = "SourceSans"
			mini.Size = UDim2.new(0, 45, 0, 28)
			mini.Text = "-"
			mini.TextSize = 40
			mini.Position = UDim2.new(0, 44, -1, 27)

			mini2.Name = "minimize2"
			mini2.Parent = main.Frame
			mini2.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
			mini2.Font = "SourceSans"
			mini2.Size = UDim2.new(0, 45, 0, 28)
			mini2.Text = "+"
			mini2.TextSize = 40
			mini2.Position = UDim2.new(0, 44, -1, 57)
			mini2.Visible = false

			speeds = 1

			local speaker = game:GetService("Players").LocalPlayer

			local chr = game.Players.LocalPlayer.Character
			local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")

			nowe = false

			game:GetService("StarterGui"):SetCore("SendNotification", { 
				Title = "FLY GUI V3";
				Text = "BY XNEO";
				Icon = "rbxthumb://type=Asset&id=5107182114&w=150&h=150"})
			Duration = 5;

			Frame.Active = true
			Frame.Draggable = true

			onof.MouseButton1Down:connect(function()

				if nowe == true then
					nowe = false

					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Climbing,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Flying,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.GettingUp,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Landed,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,true)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Swimming,true)
					speaker.Character.Humanoid:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
				else 
					nowe = true



					for i = 1, speeds do
						spawn(function()

							local hb = game:GetService("RunService").Heartbeat	


							tpwalking = true
							local chr = game.Players.LocalPlayer.Character
							local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
							while tpwalking and hb:Wait() and chr and hum and hum.Parent do
								if hum.MoveDirection.Magnitude > 0 then
									chr:TranslateBy(hum.MoveDirection)
								end
							end

						end)
					end
					game.Players.LocalPlayer.Character.Animate.Disabled = true
					local Char = game.Players.LocalPlayer.Character
					local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")

					for i,v in next, Hum:GetPlayingAnimationTracks() do
						v:AdjustSpeed(0)
					end
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Climbing,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Flying,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Freefall,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.GettingUp,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Jumping,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Landed,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Physics,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Running,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Seated,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,false)
					speaker.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Swimming,false)
					speaker.Character.Humanoid:ChangeState(Enum.HumanoidStateType.Swimming)
				end




				if game:GetService("Players").LocalPlayer.Character:FindFirstChildOfClass("Humanoid").RigType == Enum.HumanoidRigType.R6 then



					local plr = game.Players.LocalPlayer
					local torso = plr.Character.Torso
					local flying = true
					local deb = true
					local ctrl = {f = 0, b = 0, l = 0, r = 0}
					local lastctrl = {f = 0, b = 0, l = 0, r = 0}
					local maxspeed = 50
					local speed = 0


					local bg = Instance.new("BodyGyro", torso)
					bg.P = 9e4
					bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
					bg.cframe = torso.CFrame
					local bv = Instance.new("BodyVelocity", torso)
					bv.velocity = Vector3.new(0,0.1,0)
					bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
					if nowe == true then
						plr.Character.Humanoid.PlatformStand = true
					end
					while nowe == true or game:GetService("Players").LocalPlayer.Character.Humanoid.Health == 0 do
						game:GetService("RunService").RenderStepped:Wait()

						if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
							speed = speed+.5+(speed/maxspeed)
							if speed > maxspeed then
								speed = maxspeed
							end
						elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed ~= 0 then
							speed = speed-1
							if speed < 0 then
								speed = 0
							end
						end
						if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (ctrl.f+ctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
							lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
						elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (lastctrl.f+lastctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
						else
							bv.velocity = Vector3.new(0,0,0)
						end

						bg.cframe = game.Workspace.CurrentCamera.CoordinateFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed/maxspeed),0,0)
					end
					ctrl = {f = 0, b = 0, l = 0, r = 0}
					lastctrl = {f = 0, b = 0, l = 0, r = 0}
					speed = 0
					bg:Destroy()
					bv:Destroy()
					plr.Character.Humanoid.PlatformStand = false
					game.Players.LocalPlayer.Character.Animate.Disabled = false
					tpwalking = false




				else
					local plr = game.Players.LocalPlayer
					local UpperTorso = plr.Character.UpperTorso
					local flying = true
					local deb = true
					local ctrl = {f = 0, b = 0, l = 0, r = 0}
					local lastctrl = {f = 0, b = 0, l = 0, r = 0}
					local maxspeed = 50
					local speed = 0


					local bg = Instance.new("BodyGyro", UpperTorso)
					bg.P = 9e4
					bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
					bg.cframe = UpperTorso.CFrame
					local bv = Instance.new("BodyVelocity", UpperTorso)
					bv.velocity = Vector3.new(0,0.1,0)
					bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
					if nowe == true then
						plr.Character.Humanoid.PlatformStand = true
					end
					while nowe == true or game:GetService("Players").LocalPlayer.Character.Humanoid.Health == 0 do
						wait()

						if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
							speed = speed+.5+(speed/maxspeed)
							if speed > maxspeed then
								speed = maxspeed
							end
						elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed ~= 0 then
							speed = speed-1
							if speed < 0 then
								speed = 0
							end
						end
						if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (ctrl.f+ctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
							lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
						elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed ~= 0 then
							bv.velocity = ((game.Workspace.CurrentCamera.CoordinateFrame.lookVector * (lastctrl.f+lastctrl.b)) + ((game.Workspace.CurrentCamera.CoordinateFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0).p) - game.Workspace.CurrentCamera.CoordinateFrame.p))*speed
						else
							bv.velocity = Vector3.new(0,0,0)
						end

						bg.cframe = game.Workspace.CurrentCamera.CoordinateFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed/maxspeed),0,0)
					end
					ctrl = {f = 0, b = 0, l = 0, r = 0}
					lastctrl = {f = 0, b = 0, l = 0, r = 0}
					speed = 0
					bg:Destroy()
					bv:Destroy()
					plr.Character.Humanoid.PlatformStand = false
					game.Players.LocalPlayer.Character.Animate.Disabled = false
					tpwalking = false



				end

			end)

			local tis

			up.MouseButton1Down:connect(function()
				tis = up.MouseEnter:connect(function()
					while tis do
						wait()
						game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0,1,0)
					end
				end)
			end)

			up.MouseLeave:connect(function()
				if tis then
					tis:Disconnect()
					tis = nil
				end
			end)

			local dis

			down.MouseButton1Down:connect(function()
				dis = down.MouseEnter:connect(function()
					while dis do
						wait()
						game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame * CFrame.new(0,-1,0)
					end
				end)
			end)

			down.MouseLeave:connect(function()
				if dis then
					dis:Disconnect()
					dis = nil
				end
			end)


			game:GetService("Players").LocalPlayer.CharacterAdded:Connect(function(char)
				wait(0.7)
				game.Players.LocalPlayer.Character.Humanoid.PlatformStand = false
				game.Players.LocalPlayer.Character.Animate.Disabled = false

			end)


			plus.MouseButton1Down:connect(function()
				speeds = speeds + 1
				speed.Text = speeds
				if nowe == true then


					tpwalking = false
					for i = 1, speeds do
						spawn(function()

							local hb = game:GetService("RunService").Heartbeat	


							tpwalking = true
							local chr = game.Players.LocalPlayer.Character
							local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
							while tpwalking and hb:Wait() and chr and hum and hum.Parent do
								if hum.MoveDirection.Magnitude > 0 then
									chr:TranslateBy(hum.MoveDirection)
								end
							end

						end)
					end
				end
			end)
			mine.MouseButton1Down:connect(function()
				if speeds == 1 then
					speed.Text = 'cannot be less than 1'
					wait(1)
					speed.Text = speeds
				else
					speeds = speeds - 1
					speed.Text = speeds
					if nowe == true then
						tpwalking = false
						for i = 1, speeds do
							spawn(function()

								local hb = game:GetService("RunService").Heartbeat	


								tpwalking = true
								local chr = game.Players.LocalPlayer.Character
								local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
								while tpwalking and hb:Wait() and chr and hum and hum.Parent do
									if hum.MoveDirection.Magnitude > 0 then
										chr:TranslateBy(hum.MoveDirection)
									end
								end

							end)
						end
					end
				end
			end)

			closebutton.MouseButton1Click:Connect(function()
				main:Destroy()
			end)

			mini.MouseButton1Click:Connect(function()
				up.Visible = false
				down.Visible = false
				onof.Visible = false
				plus.Visible = false
				speed.Visible = false
				mine.Visible = false
				mini.Visible = false
				mini2.Visible = true
				main.Frame.BackgroundTransparency = 1
				closebutton.Position =  UDim2.new(0, 0, -1, 57)
			end)

			mini2.MouseButton1Click:Connect(function()
				up.Visible = true
				down.Visible = true
				onof.Visible = true
				plus.Visible = true
				speed.Visible = true
				mine.Visible = true
				mini.Visible = true
				mini2.Visible = false
				main.Frame.BackgroundTransparency = 0 
				closebutton.Position =  UDim2.new(0, 0, -1, 27)
			end)
        end
    end
})


MiscSection:AddToggle({
    Name = "Auto Chest",
    Default = false,
    Callback = function(state)
        getgenv().AutoChest = state

        local Players = game:GetService("Players")
        local player = Players.LocalPlayer
        local StarterGui = game:GetService("StarterGui")
        local workspace = game:GetService("Workspace")

        -- Luồng chính để thu thập chest
        task.spawn(function()
            while true do
                task.wait(1) -- delay giữa các lần quét
                if not getgenv().AutoChest then continue end

                local dropsFolder = workspace:FindFirstChild("Objects") and workspace.Objects:FindFirstChild("Drops")
                if not dropsFolder then continue end

                local drops = dropsFolder:GetChildren()
                for _, drop in ipairs(drops) do
                    local chest = drop:FindFirstChild("Chest")
                    if not chest then continue end

                    local prompt = chest:FindFirstChild("Collect")
                    if prompt
                        and prompt:IsA("ProximityPrompt")
                        and prompt.ClickablePrompt
                        and prompt.Enabled
                    then
                        fireproximityprompt(prompt)
                        task.wait(2)

                        -- Kiểm tra GUI loot
                        local gui = player:WaitForChild("PlayerGui")
                        local lootGUI = gui:FindFirstChild("Loot")

                        if lootGUI then
                            lootGUI:Destroy()
                            task.wait(1)

                            local starterLoot = StarterGui:FindFirstChild("Loot")
                            if starterLoot then
                                starterLoot:Clone().Parent = gui
                            end
                        end
                    end
                end
            end
        end)
    end
})




MiscSection:AddButton({
	Name = "No Fog",
	Flag = "NF",
	Keybind = false,
	Callback = function()
		local Lighting = game:GetService("Lighting")
			for _, light in ipairs(Lighting:GetChildren()) do
				if light:IsA("Atmosphere") or string.find(light.Name, "Blur") or string.find(light.Name, "Bloom") then
					light:Destroy()
				end
			Lighting.FogEnd = 1000000
		end
	end
})


AutoMission:AddToggle({
    Name = "InstantKill",
    Default = false,
    Callback = function(state)
        getgenv().AutoBoss = state
        if state then
            spawn(function()
                while humanoid and humanoid.Health > 0 and target.PrimaryPart and getgenv().AutoBoss do
                    if humanoid.Health <= 2500 then
                        humanoid.Health = 0
                        task.wait(1)
                        break
                    end
                end
            end)
        end
    end
})


AutoMission:AddToggle({
    Name = "Auto Invest",
    Default = false,
    Callback = function(state)
        getgenv().AutoMissionEnabled = state

        local Players = game:GetService("Players")
        local player = Players.LocalPlayer
        local StarterGui = game:GetService("StarterGui")
        local workspaceDrops = workspace:WaitForChild("Objects"):WaitForChild("Drops")


        getgenv().AutoKillMobs = false
        getgenv().AutoCollect = false
        getgenv().AutoCivilian = false

        local lastTaskText = nil

        task.spawn(function()
            while task.wait(1) do
                if not getgenv().AutoMissionEnabled then
                    getgenv().AutoKillMobs = false
                    getgenv().AutoCollect = false
                    getgenv().AutoCivilian = false
                    continue
                end

                local storylineGui = player:WaitForChild("PlayerGui"):WaitForChild("StorylineDialogue")
                local frame = storylineGui:WaitForChild("Frame")
                local questFrame = frame:WaitForChild("QuestFrame")
                local questInfo = questFrame:WaitForChild("QuestInfo")
                local taskDesc = questInfo:WaitForChild("Task"):WaitForChild("Description")
                local currentTask = taskDesc.Text


                if currentTask ~= lastTaskText then
                    getgenv().AutoKillMobs = false
                    getgenv().AutoCollect = false
                    getgenv().AutoCivilian = false
                    lastTaskText = currentTask
                end


                if game.PlaceId == InvestPlaceID then
                    getgenv().AutoKillMobs = true
                end


                if getgenv().AutoKillMobs then
                    for _, mob in ipairs(workspace:WaitForChild("Objects"):WaitForChild("Mobs"):GetChildren()) do
                        local humanoid = mob:FindFirstChild("Humanoid")
                        if humanoid and humanoid.Health > 0 then
                            humanoid.Health = 0
							task.wait(0.5)
                        end
                    end
                end


                if currentTask == "Collect all objects" then
                    if not getgenv().AutoCollect then
                        getgenv().AutoCollect = true
                        task.spawn(function()
                            while getgenv().AutoCollect and task.wait() do
                                local items = workspace:WaitForChild("Objects"):WaitForChild("MissionItems"):GetChildren()
                                if #items == 0 then
                                    getgenv().AutoCollect = false
                                    break
                                end
                                for _, item in ipairs(items) do
                                    if not getgenv().AutoCollect then break end
                                    if not item:IsDescendantOf(workspace) then continue end
                                    local char = player.Character
                                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                                    if not hrp then continue end
                                    local pivot = item:GetPivot()
                                    local offsetY = 50
							hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, offsetY, 0))
                                    task.wait(1)
                                    local prompt = item:FindFirstChild("Collect")
                                    if prompt then
                                        fireproximityprompt(prompt)
                                    end
                                    task.wait(0.5)
                                end
                            end
                        end)
                    end
                end


                if currentTask == "Rescue civilians to the gate" then
                    if not getgenv().AutoCivilian then
                        getgenv().AutoCivilian = true
                        task.spawn(function()
                            while getgenv().AutoCivilian and task.wait() do
                                local civilians = {}
                                for _, obj in ipairs(workspace:WaitForChild("Objects"):WaitForChild("MissionItems"):GetChildren()) do
                                    if obj.Name == "Civilian" then
                                        table.insert(civilians, obj)
                                    end
                                end

                                if #civilians == 0 then
                                    getgenv().AutoCivilian = false
                                    break
                                end

                                for _, civ in ipairs(civilians) do
                                    if not getgenv().AutoCivilian then break end
                                    if not civ:IsDescendantOf(workspace) then continue end
                                    local char = player.Character
                                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                                    if not hrp then continue end
                                    local pivot = civ:GetPivot()
                                    hrp.CFrame = CFrame.new(pivot.Position)
                                    task.wait(0.4)
                                    local pickup = civ:FindFirstChild("PickUp")
                                    if pickup then
                                        fireproximityprompt(pickup)
                                    end
                                    repeat task.wait() until not civ:FindFirstChild("PickUp")
                                    local spawn = workspace:WaitForChild("Map"):WaitForChild("Parts"):FindFirstChild("SpawnLocation")
                                    if spawn then
                                        hrp.CFrame = CFrame.new(spawn.Position)
                                    end
                                    task.wait(0.5)
                                end
                            end
                        end)
                    end
                end


				if currentTask ~= "Collect all objects" and currentTask ~= "Rescue civilians to the gate" then
				local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
				local replicatedStorage = game:GetService("ReplicatedStorage")
				local playerGui = player:WaitForChild("PlayerGui")

					local mobs = workspace:WaitForChild("Objects"):WaitForChild("Mobs"):GetChildren()
					for _, mob in ipairs(mobs) do
						local char = player.Character
						local hrp = char and char:FindFirstChild("HumanoidRootPart")
						if hrp and mob:IsDescendantOf(workspace) then
							local pivot = mob:GetPivot()
							local offsetY = 50
							hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, offsetY, 0))
							task.wait(4)
						end
					end
				end
            end
        end)
    end
})


getgenv().AutoBoss = false

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local workspace = game:GetService("Workspace")
local player = Players.LocalPlayer

local HoverHeight = 10
local IframeHeight = 200
local OffsetY = 20


local hrp = nil
local function UpdateHRP(char)
	task.wait(0.2)
	hrp = char:WaitForChild("HumanoidRootPart")
end

if player.Character then
	UpdateHRP(player.Character)
end

player.CharacterAdded:Connect(UpdateHRP)


local function EnableHover(hrp)
	if not hrp:FindFirstChild("BodyPosition") then
		local bp = Instance.new("BodyPosition")
		bp.MaxForce = Vector3.new(9e9,9e9,9e9)
		bp.P = 5e4
		bp.D = 1000
		bp.Name = "BodyPosition"
		bp.Parent = hrp
	end
	if not hrp:FindFirstChild("BodyGyro") then
		local bg = Instance.new("BodyGyro")
		bg.MaxTorque = Vector3.new(9e9,9e9,9e9)
		bg.P = 5e4
		bg.D = 1000
		bg.CFrame = CFrame.new(hrp.Position)
		bg.Name = "BodyGyro"
		bg.Parent = hrp
	end
end

local function DisableHover(hrp)
	local bp = hrp:FindFirstChild("BodyPosition")
	if bp then bp:Destroy() end
	local bg = hrp:FindFirstChild("BodyGyro")
	if bg then bg:Destroy() end
end


local function MoveToBoss()
	if not hrp then return end
	local bossSpawn = workspace:FindFirstChild("Objects")
		and workspace.Objects:FindFirstChild("Spawns")
		and workspace.Objects.Spawns:FindFirstChild("BossSpawn")

	if bossSpawn and bossSpawn:FindFirstChild("QuestMarker") then
		local pivot = bossSpawn:GetPivot()
		if pivot then
			hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, OffsetY, 0))
		end
	end
end

local function HoverOnMob()
	if not hrp then return end

	local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
	local dropsFolder = workspace:WaitForChild("Objects"):WaitForChild("Drops")

	local target, humanoid = nil, nil
	for _, mob in ipairs(mobsFolder:GetChildren()) do
		local h = mob:FindFirstChild("Humanoid")
		if h and h.Health > 0 and mob.PrimaryPart then
			target = mob
			humanoid = h
			break
		end
	end

	if not target then
		DisableHover(hrp)
		return
	end

	EnableHover(hrp)
	local bp = hrp:FindFirstChild("BodyPosition")
	local bg = hrp:FindFirstChild("BodyGyro")

	while humanoid and humanoid.Health > 0 and target.PrimaryPart and getgenv().AutoBoss do
		local combatAgent = humanoid:FindFirstChild("CombatAgent")
		local iframes = combatAgent and combatAgent:FindFirstChild("Statuses")
			and combatAgent.Statuses:FindFirstChild("Iframes")

		local desiredPos =
			(iframes and iframes.Value)
				and (hrp.Position + Vector3.new(0, IframeHeight, 0))
				or (target.PrimaryPart.Position + Vector3.new(0, HoverHeight, 0))

		if bp then bp.Position = desiredPos end
		if bg then bg.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(math.rad(-90),0,0) end

		task.wait(0.5)
	end
	DisableHover(hrp)
end


AutoMission:AddToggle({
	Name = "Auto Boss",
	Default = false,
	Callback = function(state)
		getgenv().AutoBoss = state

		task.spawn(function()
			while getgenv().AutoBoss do
				if hrp then
					MoveToBoss()
					HoverOnMob()
				end
				task.wait(1)
			end
		end)
	end
})


KA:AddToggle({
    Name = "Auto Mob",
    Default = false,
    Callback = function(state)
        getgenv().AutoMob = state

        local HoverHeight = 5
        local Players = game:GetService("Players")
        local workspace = game:GetService("Workspace")
        local player = Players.LocalPlayer
        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")

        local function UpdateHRP(char)
            task.wait(0.2)
            hrp = char:WaitForChild("HumanoidRootPart")
        end
        player.CharacterAdded:Connect(UpdateHRP)

        local function HoverOnNearestMob()
            if not hrp then return end

            local mobsFolder = workspace:WaitForChild("Objects"):WaitForChild("Mobs")
            local target, humanoid = nil, nil
            local closestDistance = math.huge

            for _, mob in ipairs(mobsFolder:GetChildren()) do
                local h = mob:FindFirstChild("Humanoid")
                if h and h.Health > 0 and mob.PrimaryPart then
                    local distance = (hrp.Position - mob.PrimaryPart.Position).Magnitude
                    if distance < closestDistance and distance <= 100 then
                        closestDistance = distance
                        target = mob
                        humanoid = h
                    end
                end
            end

            if not target then
                DisableHover(hrp)
                return
            end

            EnableHover(hrp)
            local bp = hrp:FindFirstChild("BodyPosition")
            local bg = hrp:FindFirstChild("BodyGyro")

            while humanoid and humanoid.Health > 0 and target.PrimaryPart and getgenv().AutoMob do
                local distance = (hrp.Position - target.PrimaryPart.Position).Magnitude
                if distance > 100 then break end -- Dừng hover nếu mob quá xa

                local desiredPos = target.PrimaryPart.Position + Vector3.new(0, HoverHeight, 0)
                if bp then bp.Position = desiredPos end
                if bg then bg.CFrame = CFrame.new(hrp.Position) * CFrame.Angles(math.rad(-90), 0, 0) end
                task.wait(0.5)
            end

            DisableHover(hrp)
        end

        task.spawn(function()
            while getgenv().AutoMob do
                if hrp then
                    HoverOnNearestMob()
                end
                task.wait(1)
            end
        end)
    end
})


getgenv().AutoReplay = false
local player = game.Players.LocalPlayer
local replicatedStorage = game:GetService("ReplicatedStorage")

local function AreDropsEmpty(dropsFolder)
    for _, obj in ipairs(dropsFolder:GetDescendants()) do
        if obj:IsA("BasePart") or obj:IsA("Model") then
            return false
        end
    end
    return true
end


function StartAutoReplay()
    task.spawn(function()
        while getgenv().AutoReplay do
            local dropsFolder = workspace:WaitForChild("Objects"):WaitForChild("Drops")
            local playerGui = player:WaitForChild("PlayerGui")


            local invResults = playerGui:FindFirstChild("InvestigationResults")
            if invResults then
                invResults:Destroy()
            end

            local readyReplay = replicatedStorage:FindFirstChild("ReadyReplay")

            if readyReplay 
               and readyReplay.Value == 0 
               and AreDropsEmpty(dropsFolder)
            then

                local remote = replicatedStorage
                    :WaitForChild("Remotes")
                    :WaitForChild("Server")
                    :WaitForChild("Misc")
                    :WaitForChild("ReadyReplay")
				task.wait(4)
                remote:FireServer()
            end
            task.wait(1) 
        end
    end)
end

AutoMission:AddToggle({
    Name = "Auto Replay",
    Default = false,
    Callback = function(State)
        getgenv().AutoReplay = State
        if State then
            StartAutoReplay()
        end
    end,
})


local SelectedTown = nil


local Towns = {
    Town1 = workspace:WaitForChild("Objects"):WaitForChild("Locations"):WaitForChild("Towns"):WaitForChild("Town1"),
    Town2 = workspace:WaitForChild("Objects"):WaitForChild("Locations"):WaitForChild("Towns"):WaitForChild("Town2"),
    Town3 = workspace:WaitForChild("Objects"):WaitForChild("Locations"):WaitForChild("Towns"):WaitForChild("Town3"),
    Town4 = workspace:WaitForChild("Objects"):WaitForChild("Locations"):WaitForChild("Towns"):WaitForChild("Town4"),
    Town5 = workspace:WaitForChild("Objects"):WaitForChild("Locations"):WaitForChild("Towns"):WaitForChild("Town5"),
}


for townName, townInstance in pairs(Towns) do
    Teleports:AddToggle({
        Name = townName,
        Default = false,
        Callback = function(state)
            if state then

                SelectedTown = townInstance

                for otherName, _ in pairs(Towns) do
                    if otherName ~= townName then
                        Teleports:UpdateToggle(otherName, false)
                    end
                end
            else

                if SelectedTown == townInstance then
                    SelectedTown = nil
                end
            end
        end
    })
end


Teleports:AddButton({
    Name = "Teleport",
    Callback = function()
        if SelectedTown then
            local player = game:GetService("Players").LocalPlayer
            local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local pivot = SelectedTown:GetPivot()
                local offsetY = 10
                hrp.CFrame = CFrame.new(pivot.Position + Vector3.new(0, offsetY, 0))
				task.wait(1)
            end
        else
            warn("Chưa chọn Town để dịch chuyển!")
        end
    end
})




local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local plr = Players.LocalPlayer

--// Cấu hình \\--
local MAX_DISTANCE = 100
local ATTACK_COUNT = 5
local WAIT_AFTER_ATTACK = 2

--// Hàm lấy mob gần nhất trong phạm vi MAX_DISTANCE \\--
local function getClosestMob()
    local mobsFolder = Workspace:WaitForChild("Objects"):WaitForChild("Mobs")
    local closestMob = nil
    local closestDistance = math.huge

    for _, mob in ipairs(mobsFolder:GetChildren()) do
        if mob:IsA("Model") then
            local humanoid = mob:FindFirstChild("Humanoid")
            local rootPart = mob:FindFirstChild("HumanoidRootPart")
            if humanoid and humanoid.Health > 0 and rootPart then
                local distance = (rootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude
                if distance < MAX_DISTANCE and distance < closestDistance then
                    closestDistance = distance
                    closestMob = mob
                end
            end
        end
    end

    return closestMob
end

--// Hàm gửi lệnh tấn công đến server \\--
local function attack(target)
    if not target then return end
    local humanoid = target:FindFirstChild("Humanoid")
    local rootPart = target:FindFirstChild("HumanoidRootPart")
    if not humanoid or humanoid.Health <= 0 or not rootPart then return end

    local playerRoot = plr.Character and plr.Character:FindFirstChild("HumanoidRootPart")
    if not playerRoot then return end

    local distance = (rootPart.Position - playerRoot.Position).Magnitude
    if distance > MAX_DISTANCE then return end

    local args = {1, {humanoid}}
    ReplicatedStorage
        :WaitForChild("Remotes")
        :WaitForChild("Server")
        :WaitForChild("Combat")
        :WaitForChild("M1")
        :FireServer(unpack(args))
end

--// Kill Aura vòng lặp chính \\--
task.spawn(function()
    local attackCounter = 0
    local currentTarget = nil

    while task.wait(0.2) do
        if getgenv().KillAura and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then


            if not currentTarget 
                or not currentTarget:FindFirstChild("Humanoid") 
                or currentTarget.Humanoid.Health <= 0
                or not currentTarget:FindFirstChild("HumanoidRootPart")
                or (currentTarget.HumanoidRootPart.Position - plr.Character.HumanoidRootPart.Position).Magnitude > MAX_DISTANCE 
            then
                currentTarget = getClosestMob()
            end

            if currentTarget then

                attack(currentTarget)
                attackCounter = attackCounter + 1

                if attackCounter >= ATTACK_COUNT then
                    attackCounter = 0
                    task.wait(WAIT_AFTER_ATTACK)
                else
                    task.wait(0.1)
                end
            end
        else
            attackCounter = 0
            currentTarget = nil
        end
    end
end)




local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local plr = Players.LocalPlayer
local Character = plr.Character or plr.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")

-- Giá trị mặc định
local WalkSpeed = 200
local JumpPower = 80

-- Hàm cập nhật Humanoid mới khi respawn
local function updateHumanoid(char)
    Character = char
    Humanoid = char:WaitForChild("Humanoid")

    -- Đặt lại WalkSpeed và JumpPower ngay khi Humanoid xuất hiện
    Humanoid.WalkSpeed = WalkSpeed
    Humanoid.JumpPower = JumpPower

    -- Theo dõi khi WalkSpeed hoặc JumpPower bị reset
    Humanoid:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
        if Humanoid.WalkSpeed ~= WalkSpeed then
            Humanoid.WalkSpeed = WalkSpeed
        end
    end)

    Humanoid:GetPropertyChangedSignal("JumpPower"):Connect(function()
        if Humanoid.JumpPower ~= JumpPower then
            Humanoid.JumpPower = JumpPower
        end
    end)
end

-- Khi respawn
plr.CharacterAdded:Connect(updateHumanoid)

-- Khởi tạo cho Character hiện tại
updateHumanoid(Character)

-- Khi người dùng thay đổi slider
SpeedAndJump:AddSlider({
    Name = "WalkSpeed",
    Value = WalkSpeed,
    Min = 16,
    Max = 300,
    Flag = "WalkSpeed",
    Textbox = true,
    Callback = function(state)
        WalkSpeed = state
        if Humanoid then
            Humanoid.WalkSpeed = WalkSpeed
        end
    end
})

SpeedAndJump:AddSlider({
    Name = "JumpPower",
    Value = JumpPower,
    Min = 50,
    Max = 500,
    Flag = "JumpPower",
    Textbox = true,
    Callback = function(state)
        JumpPower = state
        if Humanoid then
            Humanoid.JumpPower = JumpPower
        end
    end
})



for i, v in next, getconnections(Player.Idled) do 
    v:Disable() 
end
